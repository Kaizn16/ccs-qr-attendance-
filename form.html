<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Attendance System - Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url("https://placehold.co/1920x1_1080/e2e8f0/e2e8f0?text=.");
            background-repeat: no-repeat;
            background-size: cover;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="container mx-auto p-4">
        <div id="formView">
            <div class="max-w-md mx-auto bg-white/30 backdrop-blur-sm p-8 rounded-lg shadow-lg">
                <h1 class="text-2xl font-bold text-gray-800 text-center">Attendance Record</h1>
                <p class="text-center text-gray-600 mb-6">You are recording: 
                    <span id="statusTitle" class="font-bold"></span>
                </p>
                
                <form id="attendanceForm" class="space-y-4">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">Student Full Name</label>
                        <input type="text" id="name" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="e.g., First Dela Cruz">
                    </div>
                    <div>
                        <label for="course" class="block text-sm font-medium text-gray-700">Course</label>
                        <select id="course" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <option value="" disabled selected>Select your course</option>
                            <option value="BSIT">BSIT</option>
                            <option value="BSCS">BSCS</option>
                        </select>
                    </div>
                    <div>
                        <label for="yearLevel" class="block text-sm font-medium text-gray-700">Year Level</label>
                        <select id="yearLevel" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <option value="" disabled selected>Select your year level</option>
                            <option value="1st Year">1st Year</option>
                            <option value="2nd Year">2nd Year</option>
                            <option value="3rd Year">3rd Year</option>
                            <option value="4th Year">4th Year</option>
                        </select>
                    </div>
                    <div>
                        <label for="section" class="block text-sm font-medium text-gray-700">Section</label>
                        <select id="section" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <option value="" disabled selected>Select your section</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                            <option value="E">E</option>
                        </select>
                    </div>
                    <button type="submit" id="submitBtn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Submit Attendance
                    </button>
                </form>
                <div id="formMessage" class="mt-4 text-center text-sm font-medium"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            const makeWebhookUrl = "https://hook.eu2.make.com/h46vzvyqeoi9hnhosiplbu16pqoq2jd7"; 
            const backupMakeWebhookUrl = "https://hook.us2.make.com/0aoir46cn9f1u8gtt9viv0g2u6xfzhii";

            
            const urlParams = new URLSearchParams(window.location.search);
            const status = urlParams.get('status');
            const formView = document.getElementById('formView');
            const statusTitle = document.getElementById('statusTitle');
            const form = document.getElementById('attendanceForm');
            const submitBtn = document.getElementById('submitBtn');
            const formMessage = document.getElementById('formMessage');

            const getStudentKey = () => {
                const name = document.getElementById('name').value.trim().toLowerCase();
                const course = document.getElementById('course').value;
                const year = document.getElementById('yearLevel').value;
                const section = document.getElementById('section').value;
                if (name && course && year && section) {
                    return `attendance_${name}_${course}_${year}_${section}`;
                }
                return null;
            };
            
            const handleSuccessfulSubmission = (formData) => {
                const studentKey = getStudentKey();
                const newRecord = { status: status, timestamp: new Date().toISOString() };
                localStorage.setItem(studentKey, JSON.stringify(newRecord));
                
                form.classList.add('hidden');
                showMessage(`Thank you, ${formData.name}. Your ${status} has been recorded successfully.`, 'success');
            };

            if (status && (status === 'Time In' || status === 'Time Out')) {
                statusTitle.textContent = status;
                statusTitle.className = status === 'Time In' ? 'font-bold text-green-600' : 'font-bold text-red-600';

                form.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const studentKey = getStudentKey();
                    if (!studentKey) {
                        showMessage('Please fill out all fields before submitting.', 'error');
                        return;
                    }

                    const lastRecord = JSON.parse(localStorage.getItem(studentKey));
                    const lastStatus = lastRecord ? lastRecord.status : null;

                    if (status === 'Time In' && lastStatus === 'Time In') {
                        showMessage('You have already timed in. Please time out before timing in again.', 'error');
                        return;
                    } else if (status === 'Time Out' && lastStatus !== 'Time In') {
                        showMessage('You must time in before you can time out.', 'error');
                        return;
                    }
                    
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Submitting...';

                    const formData = {
                        name: document.getElementById('name').value.trim(),
                        course: document.getElementById('course').value,
                        yearLevel: document.getElementById('yearLevel').value,
                        section: document.getElementById('section').value,
                        status: status,
                        timestamp: new Date().toLocaleString('en-US', { dateStyle: 'long', timeStyle: 'medium' })
                    };

                    try {
                        const response = await fetch(makeWebhookUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(formData)
                        });

                        if (!response.ok) throw new Error('Primary webhook failed.');
                        
                        handleSuccessfulSubmission(formData);

                    } catch (error) {
                        console.error('Primary webhook failed:', error);
                        console.log('Attempting backup webhook...');

                        try {
                            const backupResponse = await fetch(backupMakeWebhookUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(formData)
                            });

                            if (!backupResponse.ok) throw new Error('Backup webhook failed.');
                            
                            handleSuccessfulSubmission(formData);

                        } catch (backupError) {
                            console.error('Backup webhook also failed:', backupError);
                            showMessage('Could not submit attendance. Please try again.', 'error');
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Submit Attendance';
                        }
                    }
                });
            } else {
                formView.innerHTML = `<div class="max-w-md mx-auto bg-white/30 backdrop-blur-sm p-8 rounded-lg shadow-lg text-center">
                                         <h1 class="text-xl font-bold text-red-600">Invalid Link</h1>
                                         <p class="text-gray-900 mt-2">Please scan a valid QR code from the attendance kiosk.</p>
                                      </div>`;
            }

            const showMessage = (msg, type) => {
                formMessage.textContent = msg;
                formMessage.className = `mt-4 text-center text-sm font-medium ${type === 'error' ? 'text-red-600' : 'text-green-600'}`;
            };
        });
    </script>
</body>
</html>